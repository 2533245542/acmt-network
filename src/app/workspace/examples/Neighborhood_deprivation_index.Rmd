---
title: 'ACMT Example: Calculating a Neighborhood Deprivation Index'
author: "Amy Youngbloom"
date: "1/13/2022"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
# knit this file with the working directory of "workspace/" instead of "workspace/examples"
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
knitr::opts_knit$set(root.dir = '../')
```

## Introduction
The ACMT can also be used to generate interpolated measures based on standard neighborhood indices that use American Community Survey data. These indices provide useful and consistent ways for researchers to operationalize measures such as deprivation, social vulnerability, or social fragmentation. One example of an index measure such as this is the Neighborhood Deprivation Index (NDI) developed by Messer et al. (2006). The NDI is a composite measure using socioeconomic variables to describe the level of deprivation of a given area. The NDI relies on American Community Survey variables, all of which are built into the default list of variables in the ACMT. As such the NDI may be a useful tool in comparing interpolated neighborhood deprivation levels around given points of interest.

In this example, we will utilize a list of establishments in Seattle either with an active marijuana retailer license or with an active alcohol license and use the NDI to compare levels of neighborhood depravity around each type of establishment.

We take the following steps:

  1. Download dispensary and alcohol retailer data and reformat into lists from WA Liquor and Cannabis Public Record website: https://lcb.wa.gov/records/frequently-requested-lists

  2. Geocode dispensary and alcohol retailers

  3. Create a function to pull ACMT measures

  4. Designate the ACS measures relevant to the NDI measure

  5. Pull designated ACS measures

  6. Transform list of measures into a wide dataframe

  7. Run a principal component analysis to find weights for each variable measure

  8. Calculate the NDI measure

  9. Create a boxplot to compare the NDI measures for dispensaries versus alcohol retailers

  10. Calculate a t-test to statistically compare NDI measures

```{r, results='hide'}
source("setup-acmt.R")
library(readxl)
library(tidyverse)
library(janitor)
```

## 1. Download data and reformat into lists

Verify the urls below for the Dispensaries and Alcohol retailers below. The lists are updated regularly and can be found here: https://lcb.wa.gov/records/frequently-requested-lists. See urls for these lists: Cannabis License Applicants and Off Premises, Licensees

```{r, results='hide'}

download.file(url = "https://lcb.wa.gov/sites/default/files/publications/Public_Records/2019/CannabisApplicants01112022.xls", 
              destfile = "external_data/downloaded_cannabis.xls") ##check records website if url is outdated


download.file(url = "https://lcb.wa.gov/sites/default/files/publications/Public_Records/2019/Off%20Premise01112022.xlsx", 
              destfile = "external_data/downloaded_alcohol.xlsx")

cannabis_dataframe <- read_excel("external_data/downloaded_cannabis.xls")
alcohol_dataframe<-read_excel("external_data/downloaded_alcohol.xlsx")

#limit to Seattle only dispensaries and create address field: 
seattle_dispensary<-cannabis_dataframe %>%
  janitor::clean_names() %>%
  filter(city == "SEATTLE", priv_desc == "MARIJUANA RETAILER", (privilege_status=="ACTIVE (ISSUED)" | privilege_status=="PENDING (ISSUED)")) %>%
     mutate(full_address = paste(street_address, 
                      city, state, 
                      zip_code, sep = ", "),  ID=paste(as.character(row_number()), 'disp', sep='.'), 
            status=privilege_status, 
            license_type='dispensary') %>%
  subset(select=c(ID, tradename, status, full_address, license_type))

seattle_alcohol<-alcohol_dataframe %>%
  janitor::clean_names() %>%
  filter(loc_city == "SEATTLE", status == "ACTIVE (ISSUED)" | status == "PENDING (ISSUED)", 
         privilege != "BEER/WINE GIFT DELIVERY") %>%
  mutate(full_address = paste(loc_address, 
                              loc_city, loc_st,  
                              loc_zip, sep = ", "),  ID=paste(as.character(row_number()), 'alcohol', sep='.'), 
         license_type='alcohol_offpremise') %>%
  subset(select=c(ID, tradename, status, full_address, license_type, privilege))
    
#transform into lists & merge:
seattle_dispensary_list<-as.list(seattle_dispensary$full_address)
seattle_dispensary_list<-structure(seattle_dispensary_list, names=(seattle_dispensary$ID))

seattle_alcohol_list<-as.list(seattle_alcohol$full_address)
seattle_alcohol_list<-structure(seattle_alcohol_list, names=(seattle_alcohol$ID))

seattle_alcohol_dispensary_list<-c(seattle_dispensary_list[1:20], seattle_alcohol_list[1:20])
```

```{r}
head(seattle_alcohol_dispensary_list)
```

## 2. Geocode dispensary and alcohol retailers list

```{r}
seattle_lat_to_long_disp_alcohol_list<-lapply(seattle_alcohol_dispensary_list, geocode)
print(seattle_lat_to_long_disp_alcohol_list[1])
```

## 3. Create a function to pull ACMT measures
Once we have a geocoded list of dispensaries and off premise alcohol sale licensees, we can write a function to pull ACS measures that we will need to calculate the NDI.


```{r, results='hide'}
get_variable_measures_from_acmt <- function(dispensary_to_lat_long_list, radius_vector, year, names_of_variable_to_get=NA, external_data_name_to_info_list=NULL, codes_of_acs_variables_to_get=NA) {
  dispensary_to_radius_to_variable_to_measures_list <- vector(mode="list", length=length(dispensary_to_lat_long_list))
  names(dispensary_to_radius_to_variable_to_measures_list) <- names(dispensary_to_lat_long_list)
  
  for(dispensary in names(dispensary_to_radius_to_variable_to_measures_list)) {
    radius_to_variable_to_measures_list <- vector(mode="list", length=length(radius_vector))
    names(radius_to_variable_to_measures_list) <- as.character(radius_vector)
    for (radius in radius_vector) {
      print(dispensary)
      print(radius)
      
      latitude <- dispensary_to_lat_long_list[[dispensary]]$latitude
      longitude <- dispensary_to_lat_long_list[[dispensary]]$longitude
      
      environmental_measures <- get_acmt_standard_array(long=longitude,
                                                        lat=latitude, radius_meters = radius, year=year, codes_of_acs_variables_to_get=codes_of_acs_variables_to_get)
      
      variable_to_measures_list <- vector(mode="list", length=length(names_of_variable_to_get))
      names(variable_to_measures_list) <- names_of_variable_to_get
      for (name_of_variable in names_of_variable_to_get) {
        value_of_variable <- environmental_measures[environmental_measures$names == name_of_variable, ]$values  
        variable_to_measures_list[[name_of_variable]] <- value_of_variable
      }
      radius_to_variable_to_measures_list[[which(radius == radius_vector)]] <- variable_to_measures_list
      radius_to_variable_to_measures_list[[as.character(radius)]] <- variable_to_measures_list
    }
    dispensary_to_radius_to_variable_to_measures_list[[dispensary]] <- radius_to_variable_to_measures_list
  }
  return(dispensary_to_radius_to_variable_to_measures_list)
}
```

## 4. Designate the ACS measures relevant to the NDI measure
Once the function is written, we need to designate which variables will be pulled and create '_count' and '_proportion' versions of each relevant variable.

```{r, results='hide'}
NDI_variables<-c("B23025_005", "C24030_019", "C24030_018", "C24030_002", "B17012_002", "B17012_001", "B06009_002", "B06009_001", "B23025_002", "B23025_001", "B25014_007", "B25014_002", "B25014_013", "B25014_008", "B11012_010", "B11012_001", "B19001_006", "B19001_005", "B19001_004", "B19001_003", "B19001_002", "B19001_001", "B19058_002", "B19058_001")
acsvars<-read_csv('ACMT/ACSColumns.csv')
acsvars<-subset(acsvars, acs_col %in% NDI_variables)

##create 'count' versions of each variable name and 'proportion' versions for each #ACS variable where applicable
acs_count_names<-paste(acsvars$var_name, "count", sep="_")
if (length(acsvars$var_name[acsvars$universe_col != ""]) == 0) {   # prevent having something that is exactly "_proportion"
  acs_proportion_names <- character(0)
} else {
  acs_proportion_names <- paste(acsvars$var_name[!is.na(acsvars$universe_col)], "proportion", sep="_")   # only non-universal variables have proportions
}
```

## 5. Pull designated ACS measures

Next we designate the ACS variable codes, the variable names, the year, and the radius for each variable that will be retrieved and we will run the function to pull the requested ACS variables. Note that this process will take several hours.

```{r, results='hide'}
codes_of_acs_variables_to_get<-acsvars$acs_col
names_of_variable_to_get<-c(acs_count_names, acs_proportion_names)
radius_vector <- c(1000)
year <- 2019
seattle_dispensary_ndi_measures<-get_variable_measures_from_acmt(dispensary_to_lat_long_list= seattle_lat_to_long_disp_alcohol_list , radius_vector=radius_vector, year=year,                                                                             names_of_variable_to_get=names_of_variable_to_get,                                                                                 codes_of_acs_variables_to_get=codes_of_acs_variables_to_get)
```

```{r}
print(seattle_dispensary_ndi_measures[[1]]$`1000`$pop_25_above_count)
```

## 6. Transform list of measures into a wide dataframe
Once the measures are pulled for each address, we will convert the list of measures to a dataframe and transform it to a wide dataframe so that data for each dispensary is on the same row. Once reformatted, we can merge the data back with the list of dispensary names (by ID number).

```{r, results='hide'}
##Convert to dataframe
convert_to_dataframe <- function (seattle_dispensary_ndi_measures) {
  dispensary_vector <- c()
  radius_vector <- c()
  variable_vector <- c()
  value_vector <- c()
  
  for(dispensary in names(seattle_dispensary_ndi_measures)){
    for(radius_character in names(seattle_dispensary_ndi_measures[[dispensary]])){
      for(variable in names(seattle_dispensary_ndi_measures[[dispensary]][[radius_character]])){
        dispensary_vector <- c(dispensary_vector, dispensary)
        radius_vector <- c(radius_vector, as.numeric(radius_character))
        variable_vector <- c(variable_vector, variable)
        value_vector <- c(value_vector, seattle_dispensary_ndi_measures[[dispensary]][[radius_character]][[variable]])
      }
    }
  }
  
  dataframe_dispensary <- data.frame(dispensary_vector, radius_vector, variable_vector, value_vector, stringsAsFactors=FALSE)
  names(dataframe_dispensary) <- c("dispensary", "radius", "variable", "value")
  return(dataframe_dispensary)
}

dataframe_dispensary <- convert_to_dataframe(seattle_dispensary_ndi_measures)

dataframe_dispensary$radius<-NULL
dispensary_wide_dataframe<-reshape(dataframe_dispensary, v.names="value",timevar = "variable", idvar = "dispensary", direction="wide")

seattle_dispensary$privilege<-'marijuana retailer'
seattle_alcohol_dispensary<-rbind(seattle_dispensary, seattle_alcohol)

seattle_disp_alcohol_ndi_measures_wide<-merge(dispensary_wide_dataframe, seattle_alcohol_dispensary, by.x='dispensary', by.y='ID', all.x=TRUE)
```

## 7. Run a principal component analysis to find weights for each variable measure
Now we can use the ACS measures that were just pulled to calculate the NDI score for the neighborhood around each dispensary. First we need to combine measures to calculate the total percent of residents with professional degrees and the total percent of housing that is crowded (2.01 or greater occupants per room), and total percent of households with an income less than $30,000.

To create the composite NDI value, we first must get the weight for individual measure by conducting a principal component analysis of the eight designated NDI variables: (1) percent of males in professional occupations, (2) percent of households in poverty, (3) percent of residents with no high school diploma, (4) the percent of residents who are unemployed, (5) the percent of crowded housing, (6) the percent of households with income less than $30,000, (7) the percent of female-headed households with dependents less than 18 years old, and (8) the percent of households on public assistance. The loadings generated by the PCA will be used to weight each measure in calculating the overall NDI summary measure for each tract. The resulting composite NDI measure is multiplied by -1 so that a higher NDI measure indicates a neighborhood with a higher level of deprivation. Finally, we standardize the NDI measures by subtracting the mean and dividing by the standard deviation so that the measure has a mean of 0 and a standard deviation of 1.

```{r, results='hide'}
#clean-up NDI measures
seattle_dispensary_ndi<-seattle_disp_alcohol_ndi_measures_wide %>%
  mutate(total_males_management_professional = value.males_in_management_count+value.males_in_professional_occup_count, 
         total_crowded_housing = value.owner_2.01_or_more_per_room_count
         + value.renter_2.01_or_more_per_room_count, 
         total_income_below_30k = value.household_income_25_29k_count + value.household_income_20_24k_count + value.houseohld_income_15_19k_count + value.household_income_10_14k_count+value.hhincome_less_than_10k_count) %>% 
  mutate(percent_males_management_professional = total_males_management_professional / value.males_16_older_workforce_count, 
         percent_crowded_housing = total_crowded_housing / (value.total_owner_occ_housing_units_rooms_count), 
         percent_income_below_30k = total_income_below_30k/value.households_income_determined_count) 

#PCA Factor Analysis
NDI_measures<-seattle_dispensary_ndi %>%
  subset(select=c(percent_males_management_professional, value.households_in_poverty_proportion, value.no_hsdiploma_proportion, value.unemployed_proportion, percent_crowded_housing, percent_income_below_30k, value.female_head_kids_proportion, value.public_asst_proportion))

ndi_pca<-princomp(NDI_measures, cor=TRUE)
```

## 8. Calculate the NDI measure
Once the NDI score has been calculated and standardized, we can construct a boxplot to compare the mean and distribution of NDI scores for establishments with a marijuana retailer license to those with an off-premise alcohol license.

```{r, results='hide'}
##assign loading values for each variable
percent_males_management_professional_loading<-ndi_pca$loadings[1]
value.households_in_poverty_proportion_loading<-ndi_pca$loadings[2]
value.no_hsdiploma_proportion_loading<-ndi_pca$loadings[3]
value.unemployed_proportion_loading<-ndi_pca$loadings[4]
percent_crowded_housing_loading<-ndi_pca$loadings[5]
percent_income_below_30k_loading<-ndi_pca$loadings[6]
value.female_head_kids_proportion_loading<-ndi_pca$loadings[7]
value.public_asst_proportion_loading<-ndi_pca$loadings[8]

#Calculated & standardize weighted NDI value using pca loadings
seattle_dispensary_ndi <-seattle_dispensary_ndi%>%
  mutate(ndi_value=((percent_males_management_professional*percent_males_management_professional_loading)+
           (value.households_in_poverty_proportion*value.households_in_poverty_proportion_loading)+
           (value.no_hsdiploma_proportion*value.no_hsdiploma_proportion_loading)+
           (value.unemployed_proportion*value.unemployed_proportion_loading)+
           (percent_crowded_housing*percent_crowded_housing_loading)) + 
           (percent_income_below_30k*percent_income_below_30k_loading) + 
           (value.female_head_kids_proportion*value.female_head_kids_proportion_loading)+
           (value.public_asst_proportion*value.public_asst_proportion_loading)*-1) %>%
  mutate(ndi_standardized=(ndi_value-mean(ndi_value))/sd(ndi_value)) %>%
  mutate(dispensary_active=ifelse(status=="ACTIVE (ISSUED)" | status=="PENDING (ISSUED)", 1, 0))
```

## 9. Create a boxplot to compare the NDI measures for dispensaries versus alcohol retailers
Once the NDI score has been calculated and standardized, we can construct a boxplot to compare the mean and distribution of NDI scores for establishments with a marijuana retailer license to those with an off-premise alcohol license.

```{r}

#look at specific types of alcohol privileges
boxplot(ndi_standardized~license_type,
        data=seattle_dispensary_ndi,
        main = "Neighborhood Deprivation Scores", 
        xlab = "Standardized NDI score", 
        ylab = "Type of License", 
        col = "cadetblue3", 
        border= "coral4",
        horizontal=TRUE)
```

## 10. Calculate a t-test to statistically compare NDI measures
We can also statistically compare the NDI measures of neighborhoods around alcohol and marijuana retailers using an independent t-test.

```{r}

ndi_ttest<-t.test(seattle_dispensary_ndi$ndi_value~seattle_dispensary_ndi$license_type, var.equal=TRUE)
ndi_ttest

```

## Additional boxplot
In addition to the comparisons of marijuana and alcohol retailer NDI measures, we can also compare across multiple types of alcohol retailers by first constructing a boxplot by license type for alcohol retailers.

```{r}

ndi_privilege_boxplot<- ggplot(seattle_dispensary_ndi[seattle_dispensary_ndi$license_type=='alcohol_offpremise',], aes(x=factor(privilege), y=ndi_standardized, fill=privilege))+  
  geom_boxplot()+
  coord_flip()+
  labs(title="Neighborhood Deprivation Scores", y="Standardized NDI value", x="Privilege Type", fill="Privilege Type")+
  theme_minimal()

ndi_privilege_boxplot
```

## Additional statistical analysis
We can also look at statistical differences between the deprivation level of neighborhoods around each alcohol establishment using an ANOVA test. First we will look at the mean and sd for NDI scores by privilege type.

```{r}
#look at table of means:
ndi_mean_table<-seattle_dispensary_ndi[seattle_dispensary_ndi$license_type=='alcohol_offpremise',] %>%
  group_by(privilege) %>%
  summarise_at(vars(ndi_standardized), list(NDI_mean=mean, NDI_SD=sd))

ndi_aov<-aov(seattle_dispensary_ndi$ndi_standardized~seattle_dispensary_ndi$privilege, data=seattle_dispensary_ndi[seattle_dispensary_ndi$license_type=='alcohol_offpremise',])
print(ndi_mean_table)
```

```{r}
summary(ndi_aov)
```
## References

Messer, L.C., Laraia, B.A., Kaufman, J.K., Eyster, J., Holzman, C., Culhane, J., Elo, I., Burke, J.G., & O'Campo, P. (2006). The Development of a Standardized Neighborhood Deprivation Index. Journal of Urban Health, 84(6): 1041-1062.


